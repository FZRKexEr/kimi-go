# PRD: LLM 错误重试机制 (P0)

## 背景

当前 kimi-go 的 LLM 客户端 (`internal/llm/client.go`) 在 API 调用失败时没有重试机制。一旦遇到 429/502/503 等临时性错误，整个 Agent Loop 就会中断，用户体验极差。

参考 kimi-cli 使用 tenacity 库实现指数退避重试，我们需要在 Go 中实现类似功能。

## 目标

为 LLM 客户端添加指数退避重试机制，在遇到可重试错误时自动重试，提高系统稳定性。

## 需求规格

### 1. 重试条件

以下错误类型应该触发重试：
- HTTP 状态码：429 (Too Many Requests)、500、502 (Bad Gateway)、503 (Service Unavailable)
- 网络错误：连接超时、连接重置、DNS 解析失败
- 空响应错误

以下错误不应该重试：
- 401 (Unauthorized)、403 (Forbidden)：认证问题
- 400 (Bad Request)：请求参数错误
- 404 (Not Found)：资源不存在

### 2. 重试策略

采用指数退避 + 抖动策略：
- 初始等待时间：300ms
- 最大等待时间：5s
- 指数因子：2
- 抖动范围：±500ms
- 最大重试次数：3 次（可在配置中调整）

公式：`wait_time = min(initial * 2^attempt, max) + jitter`

### 3. 配置项

在配置文件中添加以下选项：

```toml
[llm]
# 重试配置
max_retries = 3          # 最大重试次数，0 表示不重试
retry_initial_wait = 300 # 初始等待时间（毫秒）
retry_max_wait = 5000    # 最大等待时间（毫秒）
```

### 4. 日志与监控

每次重试应该记录日志：
- 首次失败：记录错误信息和重试计划
- 每次重试前：记录重试次数和等待时间
- 最终失败：记录所有重试都失败的信息

日志格式：`"Retrying LLM request (attempt {n}/{max}): {error}"`

### 5. 性能考虑

- 重试应该在请求级别进行，不要破坏原有的流式响应能力
- 等待期间不应该阻塞其他 goroutine
- 上下文取消应该立即停止重试

## 验收标准

### 功能测试

1. **重试触发测试**：模拟 429/500/502/503 错误，验证重试是否触发
2. **非重试错误测试**：模拟 400/401/403/404 错误，验证是否立即失败
3. **重试次数测试**：设置 max_retries=3，验证最多重试 3 次
4. **指数退避测试**：验证等待时间符合指数退避公式
5. **上下文取消测试**：在重试等待期间取消上下文，验证是否立即退出

### 集成测试

1. **Agent Loop 稳定性**：在 API 不稳定的情况下，验证 Agent Loop 能继续运行
2. **配置加载测试**：验证配置文件中的重试配置能被正确加载
3. **日志输出测试**：验证重试日志格式正确

### 性能测试

1. **并发请求测试**：验证多个并发请求的重试不会相互影响
2. **资源泄漏测试**：验证重试不会导致 goroutine 或内存泄漏

## 参考实现

- kimi-cli 的 tenacity 重试实现
- AWS SDK for Go 的重试机制
- Google Cloud Go SDK 的 exponential backoff
